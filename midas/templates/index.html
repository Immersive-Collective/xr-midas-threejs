<!DOCTYPE html>
<html>

<head>
    <title>Depth Map Result</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles/main.css') }}">
</head>

<body>
    <script type="importmap">
        {
  "imports": {
    "three": "{{ url_for('static', filename='libs/three/build/three.module.js') }}",
    "three/addons/": "{{ url_for('static', filename='libs/three/examples/jsm/') }}"
  }
}
</script>
    <script type="module">
        import * as THREE from 'three';
import Stats from 'three/addons/libs/stats.module.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
import { VRButton } from 'three/addons/webxr/VRButton.js';

let stats;
let camera, controls, scene, renderer, meshGroup
let mesh;
let imageWidth, imageHeight;
let heightData;
let xrRefSpace;
let hand1, hand2;
let controller1, controller2;
let controllerGrip1, controllerGrip2;
let conS = [];
let bgColor =  Math.random()*1000000000;

const container = document.createElement('div');
document.body.appendChild(container);

const clock = new THREE.Clock();

function processImage() {
    const form = new FormData(document.getElementById('uploadForm'));
    fetch('/upload', {
        method: 'POST',
        body: form
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }        
        initializeThreeJS(data.image_url, data.depth_image_url);
    })
    .catch(error => {
        console.error('Error uploading image:', error);
    });
}

function onXRSessionStart() {
    const session = renderer.xr.getSession();
    console.log("onSessionStart session", session);
    session.requestReferenceSpace('local').then((referenceSpace) => {
        xrRefSpace = referenceSpace;
    });
}

function onXRSessionEnd() {
    console.log("onSessionEnd")
    if (renderer.xr.isPresenting) {
        renderer.xr.end();
    }
}

function initializeThreeJS(uploadedImageUrl, depthImageUrl) {
    loadDepthImage(uploadedImageUrl, depthImageUrl);
}

function loadDepthImage(uploadedImageUrl, depthImageUrl) {
    const imageLoader = new THREE.ImageLoader();
    imageLoader.load(depthImageUrl, function (image) {
        imageWidth = image.width;
        imageHeight = image.height;
        const canvas = document.createElement('canvas');
        canvas.width = imageWidth;
        canvas.height = imageHeight;
        const context = canvas.getContext('2d');
        context.drawImage(image, 0, 0, imageWidth, imageHeight);
        const imgData = context.getImageData(0, 0, imageWidth, imageHeight);
        heightData = new Uint8Array(imageWidth * imageHeight);
        for (let i = 0, j = 0; i < imgData.data.length; i += 4, j++) {
            const r = imgData.data[i];
            const g = imgData.data[i + 1];
            const b = imgData.data[i + 2];
            heightData[j] = (r + g + b) / 3;
        }
        const textureLoader = new THREE.TextureLoader();
        textureLoader.load(uploadedImageUrl, function (texture) {
            makeMesh(texture);
        });
    });
} 

function makeScene() {
    console.log("makeScene");
    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0xefd1b5);
    
    renderer = new THREE.WebGLRenderer({ antialias: true, xrCompatible: true });
    renderer.setClearColor(0x000000, 1); 
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = false;
    renderer.xr.enabled = true;
    renderer.xr.addEventListener('sessionstart', onXRSessionStart);
    renderer.xr.addEventListener('sessionend', onXRSessionEnd);
    container.appendChild(renderer.domElement);
    
    document.body.appendChild(VRButton.createButton(renderer));
    controls = new OrbitControls(camera, renderer.domElement);
    stats = new Stats();
    
    window.addEventListener('resize', onWindowResize);
    animate();
}

function makeMesh(texture) {
    const geometry = new THREE.PlaneGeometry(imageWidth, imageHeight, imageWidth - 1, imageHeight - 1);
    geometry.rotateX(-Math.PI / 2);
    const vertices = geometry.attributes.position.array;
    for (let i = 0, j = 0, l = vertices.length; i < l; i++, j += 3) {
        vertices[j + 1] = heightData[i]*4;
    }
    
    // Check if there's an existing meshGroup in the scene and remove it
    if (meshGroup) {
        scene.remove(meshGroup);
        meshGroup = undefined;
    }

    meshGroup = new THREE.Group();
    scene.add(meshGroup)
    window.meshGroup = meshGroup;
    texture.encoding = THREE.sRGBEncoding;
    mesh = new THREE.Mesh(geometry, new THREE.MeshBasicMaterial({ map: texture })); 
    meshGroup.add(mesh);
    let someDistance = -3000;  
    meshGroup.position.set(0,0,someDistance);
    meshGroup.rotation.set(1.5,0,0);
    camera.lookAt(meshGroup.position);
    camera.position.set(0,1.7,0);
    controls.target.copy(meshGroup.position)
    controls.update();
}


function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
    renderer.setAnimationLoop(render);
}

function render(timeStamp, xrFrame) {
    renderer.render(scene, camera);
}

makeScene();


function handleUploadFormSubmission(e) {
    const formData = new FormData(document.getElementById('uploadForm'));
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Display the images
        document.getElementById('depth-image').src = `${data.depth_image_url}`
        
        // Initialize ThreeJS
        initializeThreeJS(data.image_url, data.depth_image_url);
    })
    .catch(error => {
        console.error('There was an error uploading the image:', error);
    });
}


document.getElementById('uploadForm').addEventListener('submit', handleUploadFormSubmission);

// Add an event listener for the file input change
document.querySelector('input[type="file"]').addEventListener('change', function() {
    const fileInput = this;
    const previewImg = document.getElementById('preview');

    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            // Set the preview image's src to the loaded data URL
            previewImg.src = e.target.result;
        };
        
        // Read the selected file as a data URL
        reader.readAsDataURL(fileInput.files[0]);
    }
    
    document.getElementById('uploadForm').dispatchEvent(new Event('submit')); // programmatically submit the form
});


const previewImg = document.getElementById('preview');
const depthImg = document.getElementById('depth-image');

previewImg.onerror = function() {
    this.src = "{{ url_for('static', filename='images/placeholder.webp') }}"; // replace with your default image path
};

depthImg.onerror = function() {
    this.src = "{{ url_for('static', filename='images/placeholder.webp') }}"; // replace with your default image path
};


</script>
    <div id="ui">
        <form id="uploadForm">

            <label for="file-upload" class="custom-file-upload">
                Upload Image
            </label>
            <input id="file-upload" type="file" name="file" required style="display:none;" />



        </form>
        <div id="imageContainer">
            <img class="im" id="preview" alt="Image Preview" src="{{ url_for('static', filename='images/placeholder.webp') }}">
            <img class="im" id="depth-image" alt="Depth Image" src="{{ url_for('static', filename='images/placeholder.webp') }}">
        </div>
    </div>
</body>

</html>